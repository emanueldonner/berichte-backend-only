import{closeButton as e,getFocusableElements as t,wmBodyLock as o}from"./utils.min.js";import{WmShowModalImage as a}from"./modal-image.min.js";import{WmShowModalMedia as n}from"./modal-media.min.js";import{WmShowModalPage as d}from"./modal-page.min.js";import{WmShowModalHTML as l}from"./modal-html.min.js";import{WmShowModalGallery as m}from"./modal-gallery.min.js";const s=new o;let c,i,r,u;const w=new Event("closeModal"),p=function(){document.querySelector(".wm-modal")||(i=k(),L(i));let e=0,t=-1,o="";if(Array.from(document.querySelectorAll("[data-wm-modal]")).forEach((a=>{a.dataset.wmModalGroup?(o!==a.dataset.wmModalGroup&&(e++,t=-1),o=a.dataset.wmModalGroup,t++):a.dataset.wmModalGroup||(o="",e++,t=0),a.dataset.wmModalIndex=`${e}_${t}`})),location.hash.startsWith("#wm_modal")){const e=f(),t=document.querySelector(`[data-wm-modal-index="${e}"]`);t&&y(i,null,t)}},h=(e,t=null)=>`wm_modal${t??e.dataset.wmModalIndex}`,f=e=>location.hash.match(new RegExp("#wm_modal(.*)"))[1],y=(e,o,a)=>{let n=a;if(o&&o.target.closest("[data-wm-modal]")&&(n=o.target.closest("[data-wm-modal]")),n&&n.dataset.wmModal){o&&o.preventDefault();const a=e.querySelector('[role="dialog"]');c=document.activeElement,location.hash.startsWith("#wm_")||(location.hash=h(n)),n.dataset.wmModalWidth&&(a.style.maxWidth=`${n.dataset.wmModalWidth}px`),n.dataset.wmModalHeight&&(a.style.maxHeight=`${n.dataset.wmModalHeight}px`),e.classList.add("wm-modal--active"),document.querySelector(".js-wm-site-wrapper").inert=!0,g(a,n),u=t(e),u[0].focus(),e.addEventListener("keydown",E)}},g=(e,t)=>{const o=t.dataset.wmModal,c=t.dataset.wmModalGroup;c?r=new m(t,e,c):"image"===o?r=new a(t):"video"===o||"audio"===o?r=new n(t,o):"page"===o?r=new d(t):"html"===o&&(r=new l(t)),"page"!==o&&"html"!==o&&s.lock(e),r&&e.querySelector(".wm-modal-content").appendChild(r.getContent())},v=(e,t)=>{if(e.classList.contains("wm-modal--active")&&!e.classList.contains("wm-modal--locked")){const o=e.querySelector(".wm-modal-content");e.classList.remove("wm-modal--active"),document.querySelector(".js-wm-site-wrapper").removeAttribute("inert"),e.querySelector(".wm-modal-content__page")||s.unlock(),r&&(r.close(),setTimeout((()=>{o.innerHTML=""}),300)),"popstate"!==t.type&&(history.length>2?history.back():location.hash="",setTimeout((()=>{"content"!==c.id&&c.focus()}),100)),document.dispatchEvent(w)}},E=function(e){let t=u[u.length-1];"none"===t.style.display&&(t=u[u.length-2]),9===e.keyCode&&(e.shiftKey?document.activeElement===u[0]&&(e.preventDefault(),t.focus()):document.activeElement===t&&(e.preventDefault(),u[0].focus()))},L=function(e){document.body.addEventListener("click",(t=>{y(e,t),t.target.closest(".wm-modal__close")&&v(e,t)})),document.body.addEventListener("keydown",(t=>{"Escape"===t.key&&v(e,t)})),e.addEventListener("click",_.bind(null,e)),window.addEventListener("popstate",M.bind(null,e));for(let e=0;e<document.querySelectorAll('[data-wm-modal-type="page"]').length;e++){const t=document.querySelectorAll('[data-wm-modal-type="page"]')[e];t.addEventListener("mouseenter",(function(){const e=document.createElement("link");e.rel="prefetch",e.href=t.href,document.head.appendChild(e)}),{once:!0})}},M=function(e,t){e.classList.contains("wm-modal--active")&&v(e,t)},_=function(e,t){const o=t.target;o.closest(".wm-modal-content__item")||o.closest("button")||v(e,t)},k=function(){const e=document.createElement("div");e.classList.add("wm-modal");const t=document.createElement("div");t.classList.add("wm-modal__wrapper"),t.setAttribute("role","dialog"),t.setAttribute("aria-modal",!0),q(t);const o=document.createElement("div");return o.classList.add("wm-modal-content"),t.appendChild(o),e.appendChild(t),document.body.appendChild(e),e},q=function(t){const o=e();o.classList.add("wm-modal__close"),t.appendChild(o)},S=p;export{S as wminitModal,p as wmInitModal,k as wmAttachModal,h as wmBuildModalUrlHash,f as wmGetModalIndex};