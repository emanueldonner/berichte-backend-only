import{closeSearch as e,siteSearchToggle as t,toggleSearch as r}from"./search-toggle.min.js";let s,n,o,c,a,l,i={},u=0,d=!1,h=0;let m,p,g=!1,y=0,f=0;const w=e=>{if(!document.querySelector(".js-wm-site-search"))return;if(i=e,t(),n=document.querySelector(".js-wm-site-search"),n.classList.contains("wm-site-search--static")&&(g=!0),o=document.querySelector(".js-wm-site-search-term"),!o)throw new Error('Eingabefeld mit Klasse ".js-wm-site-search-term" fehlt.');i.resultTypes||(i.resultTypes={page:"Seiten"}),s=M(),A(i.resultTypes),T(),l=i.url;const r=new URL(document.location).searchParams,c=r.get("q");document.querySelector(".js-wm-search-page")&&c&&(r.get("currentPage")&&(h=parseInt(r.get("currentPage"))),b(c))},b=async e=>{const t=await M();p=E(e,t.pages),f=p.results.length,y=Math.ceil(f/5),m=e,q(),x(p,m),f>0?(y>1?k():$(),v()):S(e)},v=()=>{document.querySelector(".js-wm-search-empty")&&document.querySelector(".js-wm-search-empty").classList.add("wm-u-dn"),document.querySelector(".js-wm-search-no-results").setAttribute("hidden","hidden"),document.querySelector(".js-wm-search-page-results").removeAttribute("hidden")},S=e=>{document.querySelector(".js-wm-search-empty")&&document.querySelector(".js-wm-search-empty").classList.remove("wm-u-dn"),document.querySelector(".js-wm-search-page-results").setAttribute("hidden","hidden"),document.querySelector(".js-wm-search-no-results").removeAttribute("hidden"),document.querySelector(".js-wm-search-no-results [aria-live]").innerHTML=i.msgs.noresult.replace("$1",`<mark>${e.replace(/<[^>]*>?/gm,"")}</mark>`)},q=()=>{document.querySelector(".js-wm-search-page-showing").textContent=i.msgs.showing.replace("$1",h+1).replace("$2",y)},L=(e,t)=>{t.preventDefault();let r=e-1,s=e+1;"prev"===e?(r=h-2,h-=1):"next"===e?(s=h+2,h+=1):h=e,q();const n=new URL(document.location).searchParams;n.set("currentPage",h),history.pushState({},null,`?${n}`),x(p,m);const o=document.querySelectorAll(".wm-pagination");for(let e=0;e<o.length;e++){const t=o[e].querySelector("ol");t.firstElementChild.style.visibility=h>0?"visible":"hidden",t.lastElementChild.style.visibility=y===h+1?"hidden":"visible",t.querySelector("[aria-current]").removeAttribute("aria-current"),t.children[h+1].querySelector("a").setAttribute("aria-current","page"),n.set("currentPage",r),t.firstElementChild.querySelector("a").href=`?${n}`,n.set("currentPage",s),t.lastElementChild.querySelector("a").href=`?${n}`}},$=()=>{const e=document.querySelectorAll(".wm-pagination");for(let t=0;t<e.length;t++){e[t].classList.remove("wm-u-db")}},C=L.bind(null,"prev"),j=L.bind(null,"next"),k=()=>{const e=document.querySelector("#paginationItem"),t=document.querySelectorAll(".wm-pagination");for(var r=0;r<t.length;r++)!function(){const s=t[r];s.classList.add("wm-u-db");const n=s.querySelector("ol"),o=n.firstElementChild,c=n.lastElementChild;o.style.visibility="visible",0===h&&(o.style.visibility="hidden"),c.style.visibility="visible",h===y-1&&(c.style.visibility="hidden");const a=new URL(document.location).searchParams;if(a.set("currentPage",h+1),c.querySelector("a").href=`?${a}`,a.set("currentPage",h-1),o.querySelector("a").href=`?${a}`,o.removeEventListener("click",C),o.addEventListener("click",C),c.removeEventListener("click",j),c.addEventListener("click",j),n.children.length>2){const e=n.querySelectorAll("li");for(let t=1;t<e.length-1;t++)e[t].remove()}for(let t=0;t<y;t++)!function(){const r=e.content.cloneNode(!0),s=r.querySelector("a");t===h&&s.setAttribute("aria-current","page");const o=L.bind(null,t);s.addEventListener("click",o),s.innerHTML+=t+1;const a=new URL(document.location).searchParams;a.set("currentPage",t),s.href=`?${a}`,n.insertBefore(r,c)}()}()},E=(e,t)=>{let r=0;const s=[];for(const n of t){const t=R(n,e);t.score>0&&(r++,s.push({page:n,score:t.score,other:t.other}))}return{results:s.sort(((e,t)=>t.score-e.score)),found:r}},x=(e,t)=>{const r=document.querySelector("#searchResult"),s=document.querySelector(".wm-search-results");s.innerHTML="",h>=y&&(h=0);for(let n=5*h;n<5*(h+1);n++)if(n<f){const o=e.results[n],c=r.content.cloneNode(!0),a=c.querySelector(".js-wm-search-result-link"),l=c.querySelector(".js-wm-search-result-text"),u=c.querySelector(".js-wm-search-result-category");if(a.innerHTML=P(o.page.t,t),a.href=o.page.u,o.page.tp||o.page.k){let e="";o.page.tp&&(e=i.resultTypes[o.page.tp]),o.page.k&&(e+=`${o.page.tp?", ":""}${o.page.k}`),u&&(u.textContent=e)}else u&&u.remove();o.page.txt&&(l.innerHTML=P(o.page.txt,t)),o.page.c&&o.page.c.toLowerCase().indexOf(t.toLowerCase())>-1&&(l.innerHTML=P(o.page.c,t,100)),o.page.f&&(l.innerHTML=`<a href="${o.page.f}.svg" download class="wm-u-df"><img width="28" height="28" style="height: 28px; margin-right: 0.5rem;" src="${o.page.f}.svg" alt="" /> „${o.page.t}“ Piktogramm download (SVG)</a>`),o.page.txt||o.page.f||o.page.c||l.remove(),s.appendChild(c)}},A=e=>{for(const[t,r]of Object.entries(e)){const e=document.createElement("div"),s=document.createElement("ul");s.classList.add("wm-search-results__list");const n=document.createElement("div");n.classList.add("wm-h5","wm-search-results__heading"),n.textContent=r,e.setAttribute("hidden","hidden"),e.setAttribute("data-result-type",t),e.appendChild(n),e.appendChild(s),document.querySelector(".js-wm-search-results").appendChild(e)}const t=document.createElement("div");t.setAttribute("hidden","hidden"),t.classList.add("wm-search-results__other","js-wm-search-other","wm-theme-bg--nebelgrau-light","wm-u-fw600"),document.querySelector(".js-wm-search-results").appendChild(t)},T=()=>{n.keydown=null,n.addEventListener("keydown",(function(e){27===e.keyCode&&(d?(O(),o.focus()):(o.value="",D()))}));const e=document.querySelector(".js-wm-search-results");let t=e.querySelectorAll("a");o.addEventListener("keyup",(function(r){t=e.querySelectorAll("a"),t.length>0&&(40===r.keyCode&&t[u].focus(),38===r.keyCode&&(u=t.length-1,t[u].focus()))})),n.addEventListener("submit",(function(t){if(t.preventDefault(),document.querySelector(".js-wm-search-page")){D(),h=0,b(o.value);const e=new URL(document.location).searchParams;e.set("q",o.value),e.set("currentPage",h),history.pushState({},null,`?${e}`)}else e.querySelectorAll("a[href]").length?location.href=e.querySelectorAll("a[href]")[0].getAttribute("href"):location.href=l}),!1),e&&(e.addEventListener("keydown",(function(e){40!==e.keyCode&&38!==e.keyCode||e.preventDefault()})),e.addEventListener("keyup",(function(r){40===r.keyCode&&(u++,u===t.length?(U(e),u=0):t[u].focus()),38===r.keyCode&&(u--,u<0?(U(e),u=0):t[u].focus()),27===r.keyCode&&D()}))),document.addEventListener("click",(function(e){null!==e.target.closest(".js-wm-search-container")||e.target.hasAttribute("data-wm-site-search-open")||D()})),i.database&&o.addEventListener("input",(async e=>{const{value:t}=e.target;await async function(e){s=await M(),window.clearTimeout(c),c=window.setTimeout((()=>{if(function(){for(const[e]of Object.entries(i.resultTypes))n.querySelector(`[data-result-type="${e}"] ul`).innerHTML=""}(),l=`${i.url}?q=${encodeURIComponent(e)}`,e.length>1){d=!0;let t=0;const r=E(e,s.pages),{found:o}=r,c=r.results,a=[];for(const r of c)r.other?t++:(_(r.page,r.score,e),-1===a.indexOf(r.page.tp)&&a.push(r.page.tp));t>0?0===a.length?H(t>1?`${t} Ergebnisse.`:`${t} Ergebnis.`,!0):H(`…und ${t} weitere Ergebnisse.`,!0):H("");for(const[e]of Object.entries(i.resultTypes))a.indexOf(e)>-1?n.querySelector(`[data-result-type="${e}"]`).removeAttribute("hidden"):n.querySelector(`[data-result-type="${e}"]`).setAttribute("hidden","hidden");0===o&&H("Keine Ergebnisse gefunden.")}else O()}),100)}(t)}),!1)},P=(e,t,r=0)=>{let s=e,n=e.toLowerCase().indexOf(t.toLowerCase());if(n>-1){let o=0,c=e.length;const a=n+t.length;let l="",i="";r>0&&(o=n-r,i="…",l="…",c=a+r),i+=e.substring(o,n),l=e.substring(a,c)+l;const u=e.substring(n,a);" "!==e.substring(a,a+1)&&" "!==e.substring(a-1,a)||(l=`&nbsp;${l.trim()}`),n>0&&" "===e.substring(n-1,n)&&(i=`${i.trim()}&nbsp;`),s=`${i}<mark>${u}</mark>${l}`}return s};function _(e,t,r){const s=document.createElement("li"),o=e.tp,c=P(e.t,r);s.innerHTML=`\n        <a href="${e.u}" class="wm-search-results__link ${"icon"===o?"wm-u-df":""} js-pl-search-result" tabindex="-1" ${"template"===o?'target="_blank"':""}>\n  ${"icon"===o?`<img src="${e.f}.svg" class="wm-search-result__icon" height="26" width="26" />`:""}\n          ${c}\n          ${e.txt?`<br>\n          <span class="wm-search-results__description">${e.txt}</span>`:""}\n        </a>\n    `,n.querySelector(`[data-result-type="${o}"] ul`).append(s)}function O(){H(""),d=!1;for(const[e]of Object.entries(i.resultTypes))n.querySelector(`[data-result-type="${e}"]`).setAttribute("hidden","hidden")}async function M(){return a||await async function(){const e=i.database,t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}}).then((e=>e.json())).catch((function(e){}));a=t}(),a}const H=(e,t)=>{const r=n.querySelector(".js-wm-search-other");r.innerHTML="",e?r.removeAttribute("hidden"):r.setAttribute("hidden","hidden");const s=document.createElement("a");s.classList.add("wm-search-results__link"),i.url&&t&&s.setAttribute("href",l),s.textContent=e,r.appendChild(s)};function R(e,t){const r=t.split(" ").filter(Boolean);let s=!1,n=0;const o=[];for(let t=0;t<r.length;t++){s=!1;let n=0;const c=r[t].toLowerCase(),a=e.t.toLowerCase().indexOf(c);c&&a>-1&&(n+=1e3),c&&e.txt&&e.txt.toLowerCase().indexOf(c)>-1&&(n+=2);const l=e.c?e.c.toLowerCase().split(c).length-1:0;e.c&&l>0&&(e.txt&&e.txt.toLowerCase().indexOf(c),-1===a&&(s=!0),n+=Number(l)),c&&e.k&&e.k.toLowerCase().indexOf(c)>-1&&(s=!1,n+=50),o[t]=n}return-1===o.indexOf(0)&&(n=o.reduce(((e,t)=>e+t),0)),{score:n,other:s}}const U=e=>{o.focus(),e.scrollTop=0},D=()=>{u=0,g?O():e()};export{w as siteSearch,r as toggleSearch};