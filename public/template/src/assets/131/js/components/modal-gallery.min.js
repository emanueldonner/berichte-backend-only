import{wmBuildModalUrlHash as t,wmGetModalIndex as e}from"./modal.min.js";import{WmShowModalImage as s}from"./modal-image.min.js";import{getNodeIndex as i,isModalActive as o}from"./utils.min.js";let n,r;const h=function(t,s,i){this.wrapper=s,this.group=i,this.link=t,this.groupLinks=document.querySelectorAll(`[data-wm-modal-group="${this.group}"]`),this.index=0,this.totalImages=this.groupLinks.length,this.touchstartX=0,this.touchstartY=0,this.touchendX=0,this.touchendY=0,this.touches=0,this.swipeTreshold=80,this.modalIndex=0;if(location.hash.startsWith("#wm_modal")){const t=e().split("_");this.modalIndex=t[0],this.index=t[1]}return this};h.prototype.moveGallery=function(e){if(document.querySelector(".wm-modal-content__gallery")&&!document.querySelector(".js-wm-site").classList.contains("wm-is-zoomed")){const s=this.wrapper.querySelectorAll(".wm-modal-content__item");for(let t=0;t<s.length;t++){s[t].querySelector("img").dataset.wmZoomDisable=!0}e&&(this.index=this.index+e),this.index<0&&(this.index=0),this.index>=s.length&&(this.index=s.length-1);const i=s[this.index].querySelector("img");i.dataset.src&&(i.src=i.dataset.src,i.removeAttribute("data-src")),setTimeout((()=>{i.dataset.wmZoomDisable=!1}),300),history.replaceState("",document.title,`${window.location.pathname}${window.location.search}#${t(null,`${this.modalIndex}_${this.index}`)}`),this.moveGalleryTransition(),this.updateThumbs(),this.showHideButtons()}},h.prototype.updateThumbs=function(){document.querySelector(".wm-modal-content__thumb[aria-selected]").removeAttribute("aria-selected"),document.querySelectorAll(".wm-modal-content__thumb")[this.index].setAttribute("aria-selected",!0)},h.prototype.moveGalleryTransition=function(){var t=-100*this.index;document.querySelector(".wm-modal-content__gallery")&&(this.gallery=document.querySelector(".wm-modal-content__gallery")),this.gallery.style.transform=`translateX(${t}%)`},h.prototype.detachControls=function(){this.next.remove(),this.prev.remove()},h.prototype.attachControls=function(t){this.wrapper.querySelector('[rel="prev"]')?(this.prev=this.wrapper.querySelector('[rel="prev"]'),this.next=this.wrapper.querySelector('[rel="next"]')):(this.prev=this.addButton("prev"),this.next=this.addButton("next"),this.wrapper.appendChild(this.prev),this.wrapper.appendChild(this.next)),this.showHideButtons()},h.prototype.addButton=function(t){let e="Vorheriges Bild",s=-1;"next"===t&&(e="NÃ¤chstes Bild",s=1);const i=document.createElement("button"),o=document.createElement("span");return o.classList.add("wm-h-vh"),o.textContent=e,i.appendChild(o),i.classList.add("wm-modal-content__control"),i.setAttribute("rel",t),i.addEventListener("click",(t=>{t.preventDefault(),this.moveGallery(s)})),i},h.prototype.getImages=function(t){if(this.groupLinks.length){this.index=i(this.groupLinks,this.link),this.showHideButtons();const e=document.createElement("nav");e.classList.add("wm-modal-content__thumbs"),e.setAttribute("aria-label","Bilder");for(let i=0;i<this.groupLinks.length;i++){const o=this.groupLinks[i],n=i!==this.index,r=new s(o,n,i!==this.index);t.appendChild(r.getContent());const h=document.createElement("button");h.dataset.index=i,i===this.index&&h.setAttribute("aria-selected",!0),h.addEventListener("click",(t=>{this.index=parseInt(h.dataset.index),this.updateThumbs(),this.moveGallery(null)}));const a=document.createElement("img");a.src=o.href,a.alt=`Bild ${i}`,h.classList.add("wm-modal-content__thumb"),h.appendChild(a),e.appendChild(h)}this.wrapper.querySelector(".wm-modal-content").appendChild(e)}},h.prototype.showHideButtons=function(){this.prev.style.removeProperty("display"),this.next.style.removeProperty("display"),this.index===this.totalImages-1&&(this.next.style.display="none",this.prev.focus()),0===this.index&&(this.prev.style.display="none",this.next.focus())},h.prototype.handleEvents=function(){document.body.addEventListener("keydown",(t=>{o()&&t.stopPropagation(),"ArrowLeft"===t.code&&this.moveGallery(-1),"ArrowRight"===t.code&&this.moveGallery(1)}))},h.prototype.handleSwipe=function(){this.touchendX+this.swipeTreshold<this.touchstartX&&this.moveGallery(1),this.touchendX-this.swipeTreshold>this.touchstartX&&this.moveGallery(-1)},h.prototype.touchStart=function(t){this.touchstartX=t.changedTouches[0].clientX,this.touchstartY=t.changedTouches[0].clientY,this.touches=t.touches.length},h.prototype.touchEnd=function(t){this.touchendX=t.changedTouches[0].clientX,this.touchendY=t.changedTouches[0].clientY,this.touches<2&&this.handleSwipe()},h.prototype.getContent=function(){return this.wrapper.querySelector(".wm-modal-content").classList.add("wm-modal-content--gallery"),this.index=0,this.attachControls(this.index),this.gallery=document.createElement("div"),this.gallery.classList.add("wm-modal-content__gallery"),this.getImages(this.gallery),this.handleEvents(),this.moveGalleryTransition(),n=this.touchStart.bind(this),r=this.touchEnd.bind(this),this.wrapper.addEventListener("touchstart",n,!1),this.wrapper.addEventListener("touchend",r,!1),this.gallery},h.prototype.close=function(){this.index=0,this.modalIndex=0,this.detachControls(),this.wrapper.querySelector(".wm-modal-content").classList.remove("wm-modal-content--gallery"),this.wrapper.removeEventListener("touchstart",n,!1),this.wrapper.removeEventListener("touchend",r,!1)};export{h as WmShowModalGallery};